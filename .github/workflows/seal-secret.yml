name: Seal and Commit Secret

on:
  workflow_dispatch:

jobs:
  seal-and-commit:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v3
      with:
        # We need to fetch the history to be able to push back to the repo
        fetch-depth: 0
        # This token is provided by Actions, and is required for the push step
        token: ${{ secrets.PAT_TOKEN }}

    - name: Install kubectl
      run: |
        curl -LO "https://dl.k8s.io/release/$(curl -L -s https://dl.k8s.io/release/stable.txt)/bin/linux/amd64/kubectl"
        chmod +x kubectl
        sudo mv kubectl /usr/local/bin/

    - name: Install kubeseal
      run: |
        wget https://github.com/bitnami-labs/sealed-secrets/releases/download/v0.17.3/kubeseal-0.17.3-linux-amd64.tar.gz
        tar -xvzf kubeseal-0.17.3-linux-amd64.tar.gz
        sudo install -m 755 kubeseal /usr/local/bin/kubeseal

    - name: Set up Kubeconfig
      run: |
        mkdir -p $HOME/.kube
        echo "${{ secrets.KUBECONFIG }}" > $HOME/.kube/config

    - name: Seal the secret
      run: |
        # Ensure the target directory exists
        mkdir -p kubernetes
        
        kubectl create secret generic google-credentials-secret --from-literal=credentials.json='${{ secrets.GOOGLE_CREDENTIALS }}' --dry-run=client -o yaml | \
        kubeseal --format yaml > kubernetes/secrets.yaml

    - name: Commit and push changes
      run: |
        git config --global user.name 'github-actions[bot]'
        git config --global user.email 'github-actions[bot]@users.noreply.github.com'
        git add kubernetes/secrets.yaml
        # Commit only if there are changes
        if ! git diff --staged --quiet; then
          git commit -m "Seal new google-credentials-secret"
          git push
        else
          echo "No changes to commit."
        fi
